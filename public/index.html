<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000" />
  <title>RPG.io</title>

  <script src="socket.io/socket.io.js"></script>
  <script src="./scripts/controllers.js"></script>
  <script src="./scripts/vue.js"></script>

  <link rel="stylesheet" href="./static/styles/style.css">
  <link rel="stylesheet" href="./static/styles/global.css">
  <link rel="stylesheet" href="./static/styles/utils.css">
</head>

<body>
  <div id="app">

    <!-- Login component -->
    <form class="welcome m-0-a text-center p-t-64 m-t-32" v-if="!inProgress && !loading" @submit="connectRoom">
      <h2 class="f-dark"> Seja bem vindo </h2>
      <p> Informe o nome da sala que deseja criar, ou informe o nome de uma sala já existente para se conectar. </p>

      <input type="text" placeholder="Insira o nome da sala" v-model="roomID">
      <button type="submit"> confirmar </button>
      <small class="m-t-32"> Este jogo é uma versão de testes e <br> pode apresentar bugs e limitações </small>
      <small> Nenhum dado será coletado </small>
    </form>

    <!-- Loading component -->
    <div class="loading m-0-a text-center m-t-64" v-if="loading && !inProgress && !error">
      <h2 class="f-dark"> Aguardando oponente </h2>
      <p> Não se esqueça de <br> enviar o nome da sala que você criou <br> para um amigo</p>
    </div>

    <!-- Fight component -->
    <div class="game m-0-a text-center" v-if="inProgress && !error">

      <div class="oponnent">
        <div class="header">
          <div class="container m-0-a is-flex">
            <h2> HP: {{ oponnent.health }}</h2>
            <h2> MP: 200</h2>
          </div>
        </div>

        <div class="view">
          <img ref="opponent" src="./static/images/warrior.png" alt="oponente">
        </div>
      </div>
      
      <div  class="personal">

        <p class="turn" v-if="user.active"> Seu turno </p>
        <p class="turn" v-if="!user.active"> Turno do oponente </p>
        <p class="m-0-a p-0 counter" v-html="counter" />

        <div class="is-flex container m-0-a status">
          <h2 class="m-0-a p-0" :class="{ 'f-warning' : user.health < 20 }"> HP: {{ user.health }} </h2>
          <h2 class="m-0-a p-0"> MP: 200 </h2>
        </div>

        <div class="is-flex m-t-16 is-end panel">
          {{ console }}
        </div>
      </div>

      <!-- Event controls -->
      <div class="is-column controls" v-if="user.active">
        <img src="./static/images/attack.png" alt="Ataque" @click="attack">
        <img src="./static/images/itens.png" alt="Itens" @click="unavailable">
        <img src="./static/images/special.png" alt="Especial" @click="unavailable">
      </div>
    </div>

    <p class="m-0-a text-center m-t-64" v-if="error" v-html="error" />
  </div>
</body>

<script>

  const socket = io.connect()

  const app = new Vue({
    el: '#app',
    data: {
      user:{
        health: 200,
        active: false,
      },
      oponnent: {
        health: 200
      },
      inProgress: false,
      loading: false,
      roomID: '',
      counter: 0,
      turnTimer: null,
      error: '',
      console: ''
    },

    methods: {
      connectRoom: function(e){
        e.preventDefault()
        if(this.roomID){
          socket.emit('connectRoom', this.roomID)
          this.loading = true
        }
      },

      damage: function (dmg) {
        this.user.health -= dmg;
        this.user.active = true

        if(dmg != 0){
          this.console = `Você perdeu ${dmg} pontos de HP`
          if (dmg > 15) this.console += '\nAtaque crítico!'

        }else{
          this.console = `Você se esquivou do golpe`
        }

        if(this.user.health <= 0){
          alert('Você perdeu!')
          this.console = 'Você perdeu!'
          socket.emit('logout')
        }
      },

      attack: function(){
        if(this.user.active){

          let dmg = attackEmiter(socket)
          
          if(dmg != 0){

            this.oponnent.health -= dmg
            this.console = `Seu golpe causou ${dmg} de dano`
            if (dmg > 15) this.console += '\nAtaque crítico!'
            
            // Make animation
            makeAnimation(this.$refs.opponent)
  
          }else{
            // Missed attack
            this.console = 'Você errou o golpe;'
          }

          clearInterval(this.turnTimer)
          this.user.active = false
          socket.emit('changeTurn')
          this.counter = 0
        }
      },

      unavailable(){
        this.console = `Essa função ainda não está disponível`
      },

      initiateCount: function(){
        this.counter = 5

        clearInterval(this.turnTimer)
        this.turnTimer = setInterval(() => {

          if(this.counter > 0){
            this.counter--

          }else{

            clearInterval(this.turnTimer)
            this.user.active = false
            socket.emit('changeTurn')

          }
        }, 1000)
      },
    },

    mounted(){

      // First event in connection (default)
      socket.on('connect', () => {
        console.log('Connected')
      })

      // Start all this fuck
      socket.on('startGame', () => {
        this.health = 200
        this.inProgress = true
        this.loading = false
      })

      // Inflinct damage in the player
      socket.on('damage', (dmg) => {
        this.damage(dmg)
      })

      // 
      socket.on('turnOn', () => {
        this.user.active = true
        this.initiateCount()
      })

      // When you win a battle
      socket.on('win', () => {
        alert('Você venceu')
        this.console += '\nVocê venceu!!'
        clearInterval(this.turnTimer)
      })

      //failToEnter
      socket.on('failToEnter', () => {
        this.error = 'Falha ao conectar. A sala esta cheia, desculpe'
      })
    }
  })

</script>
</html>