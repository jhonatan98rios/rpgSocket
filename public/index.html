<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPG.io</title>
  <script src="socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>
<body class="m-0-a">

  <div id="app">

    <!-- Login component -->
    <div class="welcome m-0-a text-center m-t-64" v-if="!inProgress && !loading">
      <h2> Seja bem vindo </h2>
      <p> Informe um novo ID para criar uma sala, <br> ou use um ID existente para se conectar </p>

      <input type="text" placeholder="Insira o nome da sala" v-model="roomID">
      <button @click="connectRoom"> Enter </button>
    </div>

    <!-- Loading component -->
    <div class="loading m-0-a text-center m-t-64" v-if="loading && !inProgress">
      <h2> Aguardando oponente </h2>
      <p> Não se esqueça de <br> enviar o nome da sala que você criou <br> para um amigo</p>
    </div>

    <!-- Fight component -->
    <div class="game m-0-a text-center" v-if="inProgress && !error">

      <div class="oponnent">
        <div class="is-flex container m-0-a">
          <h2> HP: {{ oponnent.health }}</h2>
          <h2> MP: 200</h2>
        </div>

        <div class="view">
          <img src="./static/warrior.png" alt="oponente">
        </div>
      </div>


      <p v-if="user.active"> Seu turno </p>
      <p v-if="!user.active"> Turno do oponente </p>

      <p class="m-0-a p-0" v-html="counter" />

      <div  class="personal">
        <div class="is-flex container m-0-a">
          <h2 class="m-0-a p-0"> HP: {{ user.health }} </h2>
          <h2 class="m-0-a p-0"> MP: 200 </h2>
        </div>
        <button @click="attack" v-if="user.active"> Atacar</button>
      </div>
    </div>

    <p v-if="error" v-html="error" />
  </div>
</body>

<script>

  const socket = io.connect()

  const app = new Vue({
    el: '#app',
    data: {
      user:{
        health: 200,
        active: false,
      },
      oponnent: {
        health: 200
      },
      inProgress: false,
      loading: false,
      roomID: '',
      counter: null,
      turnTimer: null,
      error: '',
    },

    methods: {
      connectRoom: function(){
        if(this.roomID){
          socket.emit('connectRoom', this.roomID)
          this.loading = true
          //console.log(this.roomID)
        }
      },

      damage: function () {
        this.user.health -= 10;
        this.user.active = true

        if(this.user.health <= 0){
          socket.emit('logout')
          alert('Você perdeu')
        }
      },

      attack: function(){
        if(this.user.active){
          this.oponnent.health -= 10
          socket.emit('attack')
          this.user.active = false

          //console.log("attack > clearInterval")
          clearInterval(this.turnTimer)

          socket.emit('changeTurn')
          this.counter = 0
        }
      },

      initiateCount: function(){
        this.counter = 5

        //console.log("initiateCount > clearInterval")
        clearInterval(this.turnTimer)

        this.turnTimer = setInterval(() => {
          if(this.counter > 0){
            this.counter--

          }else{

            //console.log("initiateCount > this.counter == 0 > clearInterval")
            clearInterval(this.turnTimer)

            this.user.active = false
            socket.emit('changeTurn')
          }
        }, 1000)
      },
    },

    mounted(){
      //console.log('Mounted')

      // First event in connection (default)
      socket.on('connect', () => {
        //console.log("Conectado como ", socket.id)
      })

      // Start all this fuck
      socket.on('startGame', () => {
        //console.log('Deveria ter começado')
        this.health = 200
        this.inProgress = true
        this.loading = false
      })

      socket.on('teste', ()=>{
        //console.log('Testando')

      })

      // Inflinct damage in the player
      socket.on('damage', () => {
        //console.log('damage')
        this.damage()
      })

      // 
      socket.on('turnOn', () => {
        console.log('turnOn')
        this.user.active = true
        this.initiateCount()
      })

      //
      socket.on('critical', () => {
        console.log("Ataque crítico")
      })

      //
      socket.on('missed', () => {
        console.log("Você errou o golpe")
      })


      // When you win a battle
      socket.on('win', () => {
        alert('Você venceu')
        clearInterval(this.turnTimer)
      })

      //failToEnter
      socket.on('failToEnter', () => {
        //console.log('failToEnter')
        this.error = 'Falha ao conectar. A sala esta cheia, desculpe'
      })
    }
  })

</script>

<style scoped>

/* Globais */
*, body{
  font-family: sans-serif;
}

p, button, input{
  color: #333;
}

input{
  border-radius: 4px;
  padding: 8px;
  border: solid 1px #ccc;
  width: 50%;
  max-width: 230px;
}

button{
  border-radius: 4px;
  padding: 8px;
  border: solid 1px #ccc;
  margin-left: 8px;
}

/* Utillity classes */

.is-flex{
  display: flex;
  justify-content: space-around;
}

.container{
  max-width: 768px;
  width: 90%;
}

.text-center{
  text-align: center;
}

.m-y-16{
  margin-top: 16px;
  margin-bottom: 16px;
}

.m-t-32{
  margin-top: 32px !important;
}

.m-t-64{
  margin-top: 64px !important;
}

.m-0-a{
  margin: 0 auto;
}

.p-o{
  padding: 0px;
}

/* CSSOM */

.welcome > h2, .loading > h2 {
  color: #55ccff;
}

.game > .oponnent > .is-flex{
  width: 100%;
  height: 50px;
  margin: 0 auto;
  padding-bottom: 16px;
}

.game > .oponnent > .view{
  height: 350px;
  width: 100%;
  background-image: url(./static/background.jpg);
  background-size: 130%;
  background-position: 40% 100%;
}

.game > .oponnent > .view > img{
  max-height: 75%;
  margin-top: 50px;
}

</style>
</html>