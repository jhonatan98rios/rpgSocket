<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPG.io</title>
  <script src="socket.io/socket.io.js"></script>
  <script src="./scripts/controllers.js"></script>
  <script src="./vue.js"></script>
</head>
<body class="m-0-a">

  <div class="texture"></div>

  <div id="app">

    <!-- Login component -->
    <div class="welcome m-0-a text-center m-t-64" v-if="!inProgress && !loading">
      <h2 class="f-dark"> Seja bem vindo </h2>
      <p> Informe um novo ID para criar uma sala, <br> ou use um ID existente para se conectar </p>

      <input type="text" placeholder="Insira o nome da sala" v-model="roomID">
      <button @click="connectRoom"> Enter </button>
    </div>

    <!-- Loading component -->
    <div class="loading m-0-a text-center m-t-64" v-if="loading && !inProgress && !error">
      <h2> Aguardando oponente </h2>
      <p> Não se esqueça de <br> enviar o nome da sala que você criou <br> para um amigo</p>
    </div>

    <!-- Fight component -->
    <div class="game m-0-a text-center" v-if="inProgress && !error">

      <div class="oponnent">
        <div class="is-flex container m-0-a">
          <h2> HP: {{ oponnent.health }}</h2>
          <h2> MP: 200</h2>
        </div>

        <div class="view">
          <img ref="opponent" src="./static/warrior.png" alt="oponente">
        </div>
      </div>

      <p class="m-0-a p-0 counter" v-html="counter" />

      <p v-if="user.active"> Seu turno </p>
      <p v-if="!user.active"> Turno do oponente </p>

      <div  class="personal">
        <div class="is-flex container m-0-a">
          <h2 class="m-0-a p-0" :class="{ 'f-warning' : user.health < 20 }"> HP: {{ user.health }} </h2>
          <h2 class="m-0-a p-0"> MP: 200 </h2>
        </div>

        <div class="is-flex m-t-16 is-end panel">
          <div class="is-column controls">
            <button v-if="user.active" @click="attack"> Atacar</button>
            <!-- <button> Magias</button>
            <button> Itens</button>
            <button> Opções</button> -->
          </div>
          <div class="is-column console">
            {{ console }}
          </div>
        </div>
      </div>
    </div>

    <p class="m-0-a text-center m-t-64" v-if="error" v-html="error" />
  </div>
</body>

<script>

  const socket = io.connect()

  const app = new Vue({
    el: '#app',
    data: {
      user:{
        health: 200,
        active: false,
      },
      oponnent: {
        health: 200
      },
      inProgress: false,
      loading: false,
      roomID: '',
      counter: 0,
      turnTimer: null,
      error: '',
      console: ''
    },

    methods: {
      connectRoom: function(){
        if(this.roomID){
          socket.emit('connectRoom', this.roomID)
          this.loading = true
        }
      },

      damage: function (dmg) {
        this.user.health -= dmg;
        this.user.active = true

        if(dmg != 0){
          this.console = `Você perdeu ${dmg} pontos de HP`
          if (dmg > 15) this.console += '\nAtaque crítico!'

        }else{
          this.console = `Você se esquivou do golpe`
        }

        if(this.user.health <= 0){
          alert('Você perdeu!')
          this.console = 'Você perdeu!'
          socket.emit('logout')
        }
      },

      attack: function(){
        if(this.user.active){

          let dmg = attackEmiter(socket)
          
          if(dmg != 0){

            this.oponnent.health -= dmg
            this.console = `Seu golpe causou ${dmg} de dano`
            if (dmg > 15) this.console += '\nAtaque crítico!'
            
            // Make animation
            makeAnimation(this.$refs.opponent)
  
          }else{
            // Missed attack
            this.console = 'Você errou o golpe;'
          }

          clearInterval(this.turnTimer)
          this.user.active = false
          socket.emit('changeTurn')
          this.counter = 0
        }
      },

      initiateCount: function(){
        this.counter = 5

        clearInterval(this.turnTimer)
        this.turnTimer = setInterval(() => {

          if(this.counter > 0){
            this.counter--

          }else{

            clearInterval(this.turnTimer)
            this.user.active = false
            socket.emit('changeTurn')

          }
        }, 1000)
      },
    },

    mounted(){

      // First event in connection (default)
      socket.on('connect', () => {
      })

      // Start all this fuck
      socket.on('startGame', () => {
        this.health = 200
        this.inProgress = true
        this.loading = false
      })

      // Inflinct damage in the player
      socket.on('damage', (dmg) => {
        this.damage(dmg)
      })

      // 
      socket.on('turnOn', () => {
        this.user.active = true
        this.initiateCount()
      })

      // When you win a battle
      socket.on('win', () => {
        alert('Você venceu')
        this.console += '\nVocê venceu!!'
        clearInterval(this.turnTimer)
      })

      //failToEnter
      socket.on('failToEnter', () => {
        this.error = 'Falha ao conectar. A sala esta cheia, desculpe'
      })
    }
  })

</script>

<style scoped>

  @font-face {
    font-family: DarkShadow;
    src: url(./static/DarkShadow.ttf);
  }

/* Globais */
*, body{
  font-family: sans-serif;
}

p, button, input{
  color: #333;
}

input{
  border-radius: 4px;
  padding: 8px;
  border: solid 1px #ccc;
  width: 50%;
  max-width: 230px;
}

button{
  border-radius: 4px;
  padding: 8px;
  border: solid 1px #ccc;
  margin-left: 8px;
}

/* Utillity classes */

.is-flex{
  display: flex;
  justify-content: space-around;
}

.is-column{
  display: flex;
  flex-direction: column;
  align-items: center;
}

.is-end{
  justify-content: end;
}

.container{
  max-width: 768px;
  width: 90%;
}

.text-center{
  text-align: center;
}

.m-y-16{
  margin-top: 16px;
  margin-bottom: 16px;
}

.m-t-16{
  margin-top: 16px !important;
}

.m-t-32{
  margin-top: 32px !important;
}

.m-t-64{
  margin-top: 64px !important;
}

.m-0-a{
  margin: 0 auto;
}

.p-o{
  padding: 0px;
}

.f-warning{
  color: #f00;
}

.f-dark{
  font-family: DarkShadow;
  font-size: 36px;
}

/* CSSOM */

.game > .oponnent > .is-flex{
  width: 100%;
  height: 50px;
  margin: 0 auto;
  padding-bottom: 16px;
}

.game > .oponnent > .view{
  height: 350px;
  width: 100%;
  background-image: url(./static/background.jpg);
  background-size: 130%;
  background-position: 40% 100%;
}

.game > .oponnent > .view > img{
  max-height: 75%;
  margin-top: 50px;
}

.counter{
  background-color: #eee;
  box-shadow: 0px 1px 3px rgba(0,0,0,.5);
  width: 20px;
  padding: 8px;
  border-radius: 50%;
  margin-top: -20px;
}

.personal{
  border-top: 1px #ccc solid;
  padding-top: 16px;
}

.panel{
  background-color: whitesmoke;
}

.controls, .console{
  border: 1px solid #ccc;
  border-bottom: none;
  width: 50%;
  height: 200px;
}

.controls > button{
  background-color: transparent;
  border: none;
  border-bottom: 1px solid #ccc;
  border-radius: 0px;
  width: 100%;
  height: 50px;
  margin: 0px;
}

.console{
  overflow-y: scroll;
  height: 200px;
  width: 50%;
  padding: 16px 8px;
}

/* Damage effect implementation */
.blink {
  animation: blinker .5s infinite;
}

@keyframes blinker {
  0%{ opacity: 0 } 
  50%{ opacity: 1 } 
  100%{ opacity: 0 } 
}
</style>
</html>